type Inputs = {
  product: string;
  benefit: string;
  audience: string;
  platform: "instagram" | "x" | "tiktok" | "snapchat" | "facebook" | "linkedin";
  tone: "friendly" | "premium" | "energetic" | "trust" | "funny";
  length: "short" | "medium" | "long";
  emoji: boolean;
  hashtags: boolean;
};

const platformHints: Record<Inputs["platform"], { cta: string; style: string }> = {
  instagram: { cta: "???? ???????? ???????", style: "???? ???? ?? ???? ?????" },
  x: { cta: "???? ????", style: "????? ??????" },
  tiktok: { cta: "???? ??????? ?????", style: "??? ????? ???????" },
  snapchat: { cta: "???? ??????", style: "???? ???? ?????" },
  facebook: { cta: "???? ????", style: "?????? ??????" },
  linkedin: { cta: "????? ????", style: "??????? ?????" },
};

const tonePhrases: Record<Inputs["tone"], string[]> = {
  friendly: ["?? ?????", "??????", "??? ????"],
  premium: ["?????", "?????? ?????", "??? ????"],
  energetic: ["?????", "???????", "???"],
  trust: ["????", "???", "??????"],
  funny: ["??? ????? ????", "?? ?????", "???? ?????? ?? ??? ???"],
};

const defaultHashtags = [
  "#????????", "#??????", "#???", "#???????", "#????", "#???????", "#????"
];

function wrapEmojis(text: string, enable: boolean): string {
  if (!enable) return text;
  const emojis = ["?", "??", "??", "??", "?", "???", "?", "??", "?", "?"];
  const pick = () => emojis[Math.floor(Math.random() * emojis.length)];
  return `${pick()} ${text} ${pick()}`;
}

function saudiFlavor(text: string): string {
  // ??? ???? ??????? ?????? ?????
  return text
    .replace(/???/g, "????")
    .replace(/????/g, "?????")
    .replace(/??/g, "???")
    .replace(/???/g, "??")
    .replace(/?? ????/g, "?? ?????");
}

function buildHashtags(inputs: Inputs): string {
  if (!inputs.hashtags) return "";
  const platformTag = `#${inputs.platform}`;
  const productTag = inputs.product ? `#${inputs.product.split(/\s+/)[0]}` : "";
  const audienceTag = inputs.audience ? `#${inputs.audience.split(/\s+/)[0]}` : "";
  const mix = [platformTag, productTag, audienceTag, ...defaultHashtags]
    .filter(Boolean)
    .slice(0, inputs.platform === "x" ? 4 : 7);
  return "\n\n" + mix.join(" ");
}

function lengthLimits(len: Inputs["length"]) {
  switch (len) {
    case "short": return { min: 80, max: 150 };
    case "medium": return { min: 150, max: 300 };
    case "long": return { min: 300, max: 600 };
  }
}

function clampByLength(text: string, len: Inputs["length"]) {
  const { min, max } = lengthLimits(len);
  if (text.length < min) return text.padEnd(min, ".");
  if (text.length > max) return text.slice(0, max - 1) + "?";
  return text;
}

function ctaForPlatform(p: Inputs["platform"]): string {
  return platformHints[p].cta;
}

export function generateAds(inputs: Inputs): string[] {
  const introTone = tonePhrases[inputs.tone];
  const intro = saudiFlavor(`${introTone[0]}! ${inputs.product} ${inputs.audience ? `??${inputs.audience}` : ""}`.trim());

  const core = saudiFlavor(
    `?? ???????? ${inputs.benefit}. ?????? ?????? ???? ?????? ?????. ` +
    `???????: ${platformHints[inputs.platform].style}.`
  );

  const call = saudiFlavor(`${ctaForPlatform(inputs.platform)} ? ${inputs.tone === "premium" ? "??? ?????" : "?? ?????"}!`);

  const variants = [
    `${wrapEmojis(intro, inputs.emoji)}\n${core}\n${call}${buildHashtags(inputs)}`,
    `${wrapEmojis(`???? ${inputs.product} ????? ${inputs.benefit}`, inputs.emoji)}. ${saudiFlavor("???? ????? ??" + (inputs.audience || "????"))}. ${call}${buildHashtags(inputs)}`,
    `${wrapEmojis("?????? ????????", inputs.emoji)} ${saudiFlavor(inputs.product)} ? ${saudiFlavor(inputs.benefit)}. ${call}${buildHashtags(inputs)}`,
  ];

  return variants.map(v => clampByLength(v, inputs.length));
}
